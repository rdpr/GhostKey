name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Read version
      id: version
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Building version $VERSION"
    
    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  Tag v${{ steps.version.outputs.version }} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âœ… Tag v${{ steps.version.outputs.version }} is new"
        fi
    
    - name: Skip if tag exists
      if: steps.check_tag.outputs.exists == 'true'
      run: |
        echo "::warning::Version v${{ steps.version.outputs.version }} already released. Update VERSION file to create a new release."
        exit 0
    
    - name: Setup Xcode
      if: steps.check_tag.outputs.exists == 'false'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install Sparkle tools
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ“¥ Installing Sparkle tools..."
        brew install sparkle
        
        # Check what was installed
        echo "ðŸ” Checking Sparkle installation..."
        brew list sparkle || echo "Sparkle not in brew list"
        
        # Find where Sparkle tools are
        echo "ðŸ” Searching for Sparkle binaries..."
        SPARKLE_PREFIX=$(brew --prefix sparkle 2>/dev/null || echo "")
        if [ -n "$SPARKLE_PREFIX" ]; then
          find "$SPARKLE_PREFIX" -name "generate_keys" 2>/dev/null || echo "generate_keys not found in $SPARKLE_PREFIX"
          find "$SPARKLE_PREFIX" -name "generate_*" 2>/dev/null || echo "No generate_* tools found"
          
          echo "ðŸ“ Sparkle installed at: $SPARKLE_PREFIX"
          ls -la "$SPARKLE_PREFIX/bin/" 2>/dev/null || echo "No bin directory at $SPARKLE_PREFIX/bin/"
          echo "ðŸ“‚ Contents of $SPARKLE_PREFIX:"
          ls -la "$SPARKLE_PREFIX/" 2>/dev/null | head -20 || echo "Cannot list directory"
        else
          echo "âš ï¸  Could not determine Sparkle installation directory"
        fi
        
        echo "âœ… Sparkle formula installed (CLI tools not included in Homebrew version)"
        echo "â„¹ï¸  See SPARKLE_KEYS_SETUP.md for manual key generation instructions"
    
    - name: Generate or use Sparkle keys
      if: steps.check_tag.outputs.exists == 'false'
      id: sparkle_keys
      run: |
        echo "ðŸ” Setting up Sparkle keys..."
        
        # Check if private key exists in secrets
        if [ -z "${{ secrets.SPARKLE_PRIVATE_KEY }}" ]; then
          echo "âš ï¸  SPARKLE_PRIVATE_KEY not found in secrets"
          echo "âš ï¸  Generating temporary key pair for this build..."
          
          # Try to find generate_keys
          echo "ðŸ” Searching for generate_keys..."
          which generate_keys || echo "generate_keys not in PATH"
          ls -la /opt/homebrew/bin/generate_keys 2>/dev/null || echo "Not in /opt/homebrew/bin"
          ls -la /usr/local/bin/generate_keys 2>/dev/null || echo "Not in /usr/local/bin"
          
          # Generate temporary key pair
          echo "ðŸ”‘ Attempting key generation..."
          if command -v generate_keys &> /dev/null; then
            generate_keys > keys.txt 2>&1
          elif [ -f /opt/homebrew/bin/generate_keys ]; then
            /opt/homebrew/bin/generate_keys > keys.txt 2>&1
          elif [ -f /usr/local/bin/generate_keys ]; then
            /usr/local/bin/generate_keys > keys.txt 2>&1
          else
            echo "âŒ generate_keys command not found!"
            echo "" > keys.txt
          fi
          
          echo "ðŸ“„ Keys file contents:"
          cat keys.txt || echo "keys.txt not readable"
          echo "---"
          
          if [ -f keys.txt ] && [ -s keys.txt ] && grep -q "Private key:" keys.txt; then
            echo "âœ… Keys file generated successfully"
            
            PRIVATE_KEY=$(cat keys.txt | grep -A 1 "Private key:" | tail -n 1 | tr -d '[:space:]')
            PUBLIC_KEY=$(cat keys.txt | grep -A 1 "Public key:" | tail -n 1 | tr -d '[:space:]')
            
            echo "ðŸ” PRIVATE_KEY length: ${#PRIVATE_KEY}"
            echo "ðŸ” PUBLIC_KEY length: ${#PUBLIC_KEY}"
            echo "ðŸ” PRIVATE_KEY preview: ${PRIVATE_KEY:0:30}..."
            echo "ðŸ” PUBLIC_KEY preview: ${PUBLIC_KEY:0:30}..."
            
            echo "private_key=$PRIVATE_KEY" >> $GITHUB_OUTPUT
            echo "public_key=$PUBLIC_KEY" >> $GITHUB_OUTPUT
            echo "âœ… Generated temporary keys"
          else
            echo "âŒ Failed to generate keys or keys file is empty/invalid"
            echo "private_key=" >> $GITHUB_OUTPUT
            echo "public_key=" >> $GITHUB_OUTPUT
          fi
        else
          echo "âœ… Using keys from GitHub Secrets"
          
          echo "private_key=${{ secrets.SPARKLE_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
          echo "public_key=${{ vars.SPARKLE_PUBLIC_KEY }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Inject public key into Info.plist
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        PUBLIC_KEY="${{ steps.sparkle_keys.outputs.public_key }}"
        
        echo "ðŸ” Debug: PUBLIC_KEY length = ${#PUBLIC_KEY}"
        echo "ðŸ” Debug: PUBLIC_KEY preview = ${PUBLIC_KEY:0:30}..."
        
        if [ -n "$PUBLIC_KEY" ] && [ ${#PUBLIC_KEY} -gt 10 ]; then
          echo "ðŸ”‘ Injecting public key into Info.plist..."
          
          # Show Info.plist before
          echo "ðŸ“„ Info.plist before injection:"
          grep -A 1 "SUPublicEDKey" GhostKey/Info.plist || echo "SUPublicEDKey not found (expected)"
          
          # Add the SUPublicEDKey to Info.plist before building
          /usr/libexec/PlistBuddy -c "Add :SUPublicEDKey string $PUBLIC_KEY" GhostKey/Info.plist 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :SUPublicEDKey $PUBLIC_KEY" GhostKey/Info.plist
          
          # Verify injection
          echo "ðŸ“„ Info.plist after injection:"
          grep -A 1 "SUPublicEDKey" GhostKey/Info.plist || echo "âŒ KEY NOT FOUND!"
          
          # Also verify using PlistBuddy
          INJECTED_KEY=$(/usr/libexec/PlistBuddy -c "Print :SUPublicEDKey" GhostKey/Info.plist 2>/dev/null || echo "")
          
          if [ -n "$INJECTED_KEY" ]; then
            echo "âœ… Public key successfully injected and verified"
            echo "ðŸ” Injected key preview: ${INJECTED_KEY:0:30}..."
          else
            echo "âŒ Public key injection failed!"
            exit 1
          fi
        else
          echo "âš ï¸  No valid public key available (length: ${#PUBLIC_KEY})"
          echo "âš ï¸  Building without signature verification"
          echo "âš ï¸  Updates will still work, but won't be cryptographically verified"
          echo ""
          echo "â„¹ï¸  To enable signed updates:"
          echo "   1. Run: brew install sparkle && generate_keys"
          echo "   2. Add SPARKLE_PRIVATE_KEY and SPARKLE_PUBLIC_KEY to GitHub Secrets"
          echo "   3. Re-run this workflow"
          echo ""
          echo "ðŸ“ Continuing build without public key..."
        fi
    
    - name: Build app
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ”¨ Building GhostKey..."
        xcodebuild clean build \
          -project GhostKey.xcodeproj \
          -scheme GhostKey \
          -configuration Release \
          -derivedDataPath ./build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
        
        echo "âœ… Build complete"
    
    - name: Prepare app bundle
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ“¦ Preparing app bundle..."
        
        # Find the built app
        APP_PATH=$(find ./build -name "GhostKey.app" -type d | head -n 1)
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ GhostKey.app not found"
          exit 1
        fi
        
        echo "Found app at: $APP_PATH"
        
        # Create distribution directory
        mkdir -p ./dist
        
        # Copy app to distribution directory
        cp -R "$APP_PATH" ./dist/GhostKey.app
        
        # Ensure executable has correct permissions
        echo "ðŸ”§ Setting executable permissions..."
        chmod +x ./dist/GhostKey.app/Contents/MacOS/GhostKey
        
        # Verify bundle structure
        echo "ðŸ“‹ Verifying bundle structure..."
        if [ ! -f "./dist/GhostKey.app/Contents/MacOS/GhostKey" ]; then
          echo "âŒ Executable not found!"
          exit 1
        fi
        if [ ! -f "./dist/GhostKey.app/Contents/Info.plist" ]; then
          echo "âŒ Info.plist not found!"
          exit 1
        fi
        
        echo "âœ… App bundle prepared and verified"
    
    - name: Create ZIP archive
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ“¦ Creating ZIP archive..."
        cd ./dist
        zip -r -y "../GhostKey-${{ steps.version.outputs.version }}.zip" GhostKey.app
        cd ..
        echo "âœ… ZIP created: GhostKey-${{ steps.version.outputs.version }}.zip"
    
    - name: Install create-dmg
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ“¥ Installing create-dmg..."
        brew install create-dmg
    
    - name: Create DMG
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ“¦ Creating DMG..."
        
        # Create DMG with nice window and background
        create-dmg \
          --volname "GhostKey" \
          --volicon "./Media.xcassets/AppIcon.appiconset/GhostKey-512.png" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "GhostKey.app" 175 190 \
          --hide-extension "GhostKey.app" \
          --app-drop-link 425 190 \
          --no-internet-enable \
          "GhostKey-${{ steps.version.outputs.version }}.dmg" \
          "./dist/GhostKey.app" || true
        
        # Fallback: If create-dmg fails, create a simple DMG
        if [ ! -f "GhostKey-${{ steps.version.outputs.version }}.dmg" ]; then
          echo "âš ï¸  create-dmg failed, creating simple DMG..."
          hdiutil create -volname "GhostKey" \
            -srcfolder "./dist/GhostKey.app" \
            -ov -format UDZO \
            "GhostKey-${{ steps.version.outputs.version }}.dmg"
        fi
        
        echo "âœ… DMG created: GhostKey-${{ steps.version.outputs.version }}.dmg"
    
    - name: Sign ZIP for Sparkle
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ” Signing ZIP with EdDSA..."
        
        PRIVATE_KEY="${{ steps.sparkle_keys.outputs.private_key }}"
        
        # Sign the ZIP if we have a private key
        if [ -n "$PRIVATE_KEY" ]; then
          SIGNATURE=$(/opt/homebrew/bin/sign_update "GhostKey-${{ steps.version.outputs.version }}.zip" "$PRIVATE_KEY" 2>/dev/null || /usr/local/bin/sign_update "GhostKey-${{ steps.version.outputs.version }}.zip" "$PRIVATE_KEY" 2>/dev/null || echo "")
          
          if [ -n "$SIGNATURE" ]; then
            echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
            echo "âœ… ZIP signed successfully"
          else
            echo "âš ï¸  Signature generation failed"
            echo "signature=" >> $GITHUB_OUTPUT
          fi
        else
          echo "âš ï¸  No private key available, skipping signature"
          echo "signature=" >> $GITHUB_OUTPUT
        fi
      id: sign_zip
    
    - name: Update appcast.xml
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ“ Updating appcast.xml..."
        
        VERSION="${{ steps.version.outputs.version }}"
        SIGNATURE="${{ steps.sign_zip.outputs.signature }}"
        PUBLIC_KEY="${{ steps.sign_zip.outputs.public_key }}"
        DOWNLOAD_URL="https://github.com/rdpr/GhostKey/releases/download/v${VERSION}/GhostKey-${VERSION}.zip"
        ZIP_SIZE=$(stat -f%z "GhostKey-${VERSION}.zip" 2>/dev/null || stat -c%s "GhostKey-${VERSION}.zip")
        PUBDATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")
        
        # Create new item entry
        cat > new_item.xml << EOF
        <item>
            <title>Version ${VERSION}</title>
            <sparkle:version>${VERSION}</sparkle:version>
            <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
            <link>https://github.com/rdpr/GhostKey/releases/tag/v${VERSION}</link>
            <sparkle:releaseNotesLink>https://github.com/rdpr/GhostKey/releases/tag/v${VERSION}</sparkle:releaseNotesLink>
            <pubDate>${PUBDATE}</pubDate>
            <enclosure 
                url="${DOWNLOAD_URL}"
                sparkle:version="${VERSION}"
                sparkle:shortVersionString="${VERSION}"
                length="${ZIP_SIZE}"
                type="application/octet-stream"
                sparkle:edSignature="${SIGNATURE}"
            />
            <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
        </item>
        EOF
        
        # Insert new item at the top of the channel
        if [ -f appcast.xml ]; then
          # Use awk to insert after <channel> tag
          awk '/<channel>/ {print; getline; print "        <!-- Auto-generated by GitHub Actions -->"; while (getline < "new_item.xml") print; next} 1' appcast.xml > appcast_new.xml
          mv appcast_new.xml appcast.xml
        else
          # Create new appcast if it doesn't exist
          echo '<?xml version="1.0" encoding="utf-8"?>' > appcast.xml
          echo '<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">' >> appcast.xml
          echo '    <channel>' >> appcast.xml
          echo '        <title>GhostKey Updates</title>' >> appcast.xml
          echo '        <link>https://github.com/rdpr/GhostKey</link>' >> appcast.xml
          echo '        <description>Most recent updates to GhostKey</description>' >> appcast.xml
          echo '        <language>en</language>' >> appcast.xml
          echo '        <!-- Auto-generated by GitHub Actions -->' >> appcast.xml
          cat new_item.xml >> appcast.xml
          echo '    </channel>' >> appcast.xml
          echo '</rss>' >> appcast.xml
        fi
        
        rm -f new_item.xml
        
        echo "âœ… Appcast updated"
    
    - name: Commit appcast changes
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ’¾ Committing appcast changes..."
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add appcast.xml
        
        if git diff --staged --quiet; then
          echo "âš ï¸  No changes to commit"
        else
          git commit -m "chore: update appcast for v${{ steps.version.outputs.version }}"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          echo "âœ… Appcast committed and pushed"
        fi
    
    - name: Generate checksums
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ” Generating checksums..."
        shasum -a 256 "GhostKey-${{ steps.version.outputs.version }}.zip" > "GhostKey-${{ steps.version.outputs.version }}.zip.sha256"
        shasum -a 256 "GhostKey-${{ steps.version.outputs.version }}.dmg" > "GhostKey-${{ steps.version.outputs.version }}.dmg.sha256"
        
        echo "ðŸ“‹ Checksums:"
        cat "GhostKey-${{ steps.version.outputs.version }}.zip.sha256"
        cat "GhostKey-${{ steps.version.outputs.version }}.dmg.sha256"
    
    - name: Create release notes
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ“ Generating release notes..."
        
        cat > release_notes.md << 'EOF'
        ## GhostKey v${{ steps.version.outputs.version }}
        
        ### ðŸ“¦ Installation
        
        Choose one of the following:
        
        1. **DMG (Recommended)**: Download `GhostKey-${{ steps.version.outputs.version }}.dmg`, open it, and drag GhostKey to your Applications folder
        2. **ZIP**: Download `GhostKey-${{ steps.version.outputs.version }}.zip`, extract it, and move GhostKey.app to your Applications folder
        
        ### ðŸ”’ Important: Opening the App
        
        This build is **not code-signed or notarized**. macOS Gatekeeper will block it by default.
        
        **Required step to open the app**:
        
        Open Terminal and run this command:
        ```bash
        xattr -d com.apple.quarantine /Applications/GhostKey.app
        ```
        
        Then double-click GhostKey.app to open it normally.
        
        > **Note**: This removes the quarantine flag that macOS adds to downloaded apps. You only need to do this once.
        
        ### âš ï¸ Known Limitation: Notifications
        
        **System notifications will NOT work** in this unsigned build. macOS requires apps to be code-signed to register for notifications.
        
        **If you need notifications**, you must build from source:
        1. Clone the repository
        2. Open `GhostKey.xcodeproj` in Xcode
        3. Build and run (âŒ˜R)
        
        Local builds are automatically signed by Xcode and have full notification support.
        
        See [DEVELOPMENT.md](https://github.com/rdpr/ghostkey/blob/main/DEVELOPMENT.md#notification-issues-unsigned-apps) for details.
        
        ### âœ… Checksums
        
        Verify your download:
        
        ```
        $(cat GhostKey-${{ steps.version.outputs.version }}.zip.sha256)
        $(cat GhostKey-${{ steps.version.outputs.version }}.dmg.sha256)
        ```
        
        ### ðŸ“‹ What's New
        
        See [CHANGELOG.md](https://github.com/rdpr/ghostkey/blob/main/CHANGELOG.md) for detailed changes.
        
        ---
        
        **Requirements**: macOS 12.0 (Monterey) or later
        
        **Permissions**: Accessibility access required for typing codes (you'll be prompted on first use)
        EOF
        
        echo "âœ… Release notes generated"
    
    - name: Create Git tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "ðŸ·ï¸  Creating tag v${{ steps.version.outputs.version }}..."
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
        
        # Push tag using HTTPS with token
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git "v${{ steps.version.outputs.version }}"
        
        echo "âœ… Tag created and pushed"
    
    - name: Create GitHub Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: v${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          GhostKey-${{ steps.version.outputs.version }}.zip
          GhostKey-${{ steps.version.outputs.version }}.zip.sha256
          GhostKey-${{ steps.version.outputs.version }}.dmg
          GhostKey-${{ steps.version.outputs.version }}.dmg.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Release summary
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- \`GhostKey-${{ steps.version.outputs.version }}.dmg\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`GhostKey-${{ steps.version.outputs.version }}.zip\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Release Page](https://github.com/rdpr/ghostkey/releases/tag/v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        echo "- [All Releases](https://github.com/rdpr/ghostkey/releases)" >> $GITHUB_STEP_SUMMARY

