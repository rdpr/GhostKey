name: PR Build Check

on:
   pull_request:
     branches:
       - main
       - dev
     paths-ignore:
       - '**.md'
       - '.gitignore'
       - 'LICENSE'

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install Apple Certificate
      run: |
        echo "ðŸ” Installing Developer ID certificate..."
        
        # Decode certificate
        echo "${{ secrets.APPLE_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
        
        # Create temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        # Import certificate to keychain
        security import certificate.p12 \
          -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" \
          -k "$KEYCHAIN_PATH" \
          -T /usr/bin/codesign \
          -T /usr/bin/security
        
        # Set keychain as default
        security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | sed s/\"//g)
        security default-keychain -s "$KEYCHAIN_PATH"
        
        # Enable codesigning from a non user interactive shell
        security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        # Clean up certificate file
        rm -f certificate.p12
        
        # Store keychain path for cleanup
        echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
        echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
        
        echo "âœ… Certificate installed successfully"
        
        # Verify certificate
        security find-identity -v -p codesigning "$KEYCHAIN_PATH"
    
    - name: Build app
      run: |
        echo "ðŸ”¨ Building GhostKey..."
        xcodebuild clean build \
          -project GhostKey.xcodeproj \
          -scheme GhostKey \
          -configuration Debug \
          -derivedDataPath ./build \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="${{ vars.APPLE_CODE_SIGN_IDENTITY }}" \
          DEVELOPMENT_TEAM="${{ vars.APPLE_TEAM_ID }}"
        
        echo "âœ… Build successful"
    
    - name: Check for app bundle
      run: |
        APP_PATH=$(find ./build -name "GhostKey.app" -type d | head -n 1)
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ GhostKey.app not found"
          exit 1
        fi
        
        echo "âœ… App bundle found at: $APP_PATH"
    
    - name: Cleanup keychain
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up keychain..."
        
        if [ -n "$KEYCHAIN_PATH" ]; then
          security delete-keychain "$KEYCHAIN_PATH" || true
          echo "âœ… Keychain deleted"
        else
          echo "âš ï¸  No keychain to clean up"
        fi
    
    - name: Build summary
      run: |
        echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The app builds successfully and is ready for merge." >> $GITHUB_STEP_SUMMARY

