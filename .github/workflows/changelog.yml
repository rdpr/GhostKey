name: Auto-Generate CHANGELOG

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - beta
      - dev

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install conventional-changelog
      run: npm install -g conventional-changelog-cli
    
    - name: Determine version and channel
      id: version
      run: |
        BRANCH="${{ github.base_ref }}"
        
        echo "üéØ Target branch: $BRANCH"
        
        # Fetch all tags
        git fetch --tags
        
        # Find the latest semantic version tag (stable releases only for base version)
        LATEST_STABLE_TAG=$(git tag -l "v*.*.*" | grep -v "-" | sort -V | tail -1)
        
        if [ -z "$LATEST_STABLE_TAG" ]; then
          # No stable tags found, start from 1.0.0
          CURRENT_VERSION="1.0.0"
          echo "üì¶ No previous stable release found, starting from $CURRENT_VERSION"
        else
          CURRENT_VERSION="${LATEST_STABLE_TAG#v}"
          echo "üì¶ Latest stable version: $CURRENT_VERSION"
        fi
        
        # Parse current version
        MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
        MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
        PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)
        
        echo "üìã Current: $MAJOR.$MINOR.$PATCH"
        
        # Get PR title to determine version bump
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "üìù PR Title: $PR_TITLE"
        
        # Check for breaking changes (major bump)
        if echo "$PR_TITLE" | grep -qE '^[a-z]+(\([a-z]+\))?!:'; then
          BUMP="major"
          NEW_MAJOR=$((MAJOR + 1))
          NEW_MINOR=0
          NEW_PATCH=0
          echo "üí• Breaking change detected ‚Üí MAJOR bump"
        # Check for features (minor bump)
        elif echo "$PR_TITLE" | grep -qE '^feat(\([a-z]+\))?:'; then
          BUMP="minor"
          NEW_MAJOR=$MAJOR
          NEW_MINOR=$((MINOR + 1))
          NEW_PATCH=0
          echo "‚ú® Feature detected ‚Üí MINOR bump"
        # Everything else is a patch
        else
          BUMP="patch"
          NEW_MAJOR=$MAJOR
          NEW_MINOR=$MINOR
          NEW_PATCH=$((PATCH + 1))
          echo "üîß Patch changes ‚Üí PATCH bump"
        fi
        
        BASE_VERSION="${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
        echo "üì¶ New base version: $BASE_VERSION"
        
        # Apply channel suffix
        if [ "$BRANCH" = "main" ]; then
          FULL_VERSION="$BASE_VERSION"
          CHANNEL="stable"
          echo "‚úÖ Stable release: $FULL_VERSION"
        else
          CHANNEL="$BRANCH"  # "dev" or "beta"
          
          # Find latest tag for this version+channel
          LATEST_TAG=$(git tag -l "v${BASE_VERSION}-${CHANNEL}.*" | sort -V | tail -1)
          
          if [ -z "$LATEST_TAG" ]; then
            COUNTER=1
            echo "üì¶ First $CHANNEL release for version $BASE_VERSION"
          else
            # Extract counter from tag (e.g., v1.1.0-beta.2 -> 2)
            COUNTER=$(echo "$LATEST_TAG" | grep -oE '[0-9]+$')
            COUNTER=$((COUNTER + 1))
            echo "üì¶ Found latest tag: $LATEST_TAG"
            echo "‚¨ÜÔ∏è  Incrementing counter to: $COUNTER"
          fi
          
          FULL_VERSION="${BASE_VERSION}-${CHANNEL}.${COUNTER}"
          echo "‚úÖ $CHANNEL release: $FULL_VERSION"
        fi
        
        echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
        echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
        echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
        
        echo "üöÄ Version for CHANGELOG: $FULL_VERSION (base: $BASE_VERSION, channel: $CHANNEL)"
    
    - name: Generate CHANGELOG entry
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        CHANNEL="${{ steps.version.outputs.channel }}"
        
        echo "üìù Generating CHANGELOG for $VERSION ($CHANNEL)..."
        
        # Generate changelog for current version
        conventional-changelog -p angular -i CHANGELOG.md -s -r 0
        
        # Add channel badge if not stable
        if [ "$CHANNEL" != "stable" ]; then
          # Add a channel indicator at the top of the new entry
          BADGE="**[$CHANNEL release]**"
          sed -i "0,/## \[/s//## \[$BADGE\] [/" CHANGELOG.md
        fi
        
        echo "‚úÖ CHANGELOG generated"
    
    - name: Check for changes
      id: check_changes
      run: |
        git diff --quiet CHANGELOG.md || echo "changed=true" >> $GITHUB_OUTPUT
    
    - name: Commit CHANGELOG changes
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        git add CHANGELOG.md
        git commit -m "chore: update CHANGELOG for ${{ steps.version.outputs.version }} [skip ci]"
        git push
        
        echo "‚úÖ CHANGELOG committed to PR branch"
    
    - name: Comment on PR
      if: steps.check_changes.outputs.changed == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const version = '${{ steps.version.outputs.version }}';
          const channel = '${{ steps.version.outputs.channel }}';
          
          let channelEmoji = 'üöÄ';
          if (channel === 'beta') channelEmoji = '‚ö†Ô∏è';
          if (channel === 'dev') channelEmoji = 'üöß';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ${channelEmoji} CHANGELOG Updated

          The CHANGELOG has been automatically generated for version **\`${version}\`** (\`${channel}\` channel).

          This entry was created from the conventional commit format of your PR title.

          If this is a major release, you may want to manually enhance the CHANGELOG with:
          - Breaking changes section
          - Migration guide
          - Detailed feature descriptions

          The CHANGELOG will be included in the release notes when this PR is merged.`
          })
    
    - name: No changes needed
      if: steps.check_changes.outputs.changed != 'true'
      run: |
        echo "‚ÑπÔ∏è  CHANGELOG is already up to date"

